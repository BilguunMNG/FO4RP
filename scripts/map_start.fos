#include "_macros.fos"
#include "_cell.fos"

import void   CreateCell( uint16 x, uint16 y, uint mapId, uint8 type, int8 visibility ) from "globalmap_group";
import int    GetCellMap( uint16 x, uint16 y ) from "globalmap_group";
import void   unsafe_arcade( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 ) from "arcade_menu";
import string TimeToString( Critter& player ) from "gm";
import void   ShowInputBoxScreen( Critter& cr, string funcName, uint16 textLength, uint8 flags ) from "main";
import void   OpenLinkRemote( Critter& player, string& url) from "link";

void _StartMapInit( Map& map, bool firstTime )
{
    map.SetEvent( MAP_EVENT_OUT_CRITTER, "_crOut" );
    map.SetEvent( MAP_EVENT_IN_CRITTER, "_crIn" );
}

void _ArcadeKindmanInit( Critter& cr, bool firstTime )
{
    cr.StatBase[ ST_DIALOG_ID ] = 331;   // нпц_гайд
    cr.ModeBase[ MODE_NO_WALK ] = 1;
    cr.ModeBase[ MODE_NO_RUN ] = 1;
    cr.ModeBase[ MODE_NO_STEAL ] = 1;
    cr.ModeBase[ MODE_NO_PVP ] = 1;
    cr.ModeBase[ MODE_INVULNERABLE ] = 1;
    cr.ModeBase[ MODE_NO_PUSH ] = 1;
    cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 1;
    cr.ModeBase[ MODE_NO_UNARMED ] = 1;
    cr.ParamBase[ QST_INVIS ] = 40;
    cr.SetEvent( CRITTER_EVENT_TALK, "_ArcadeKindman_talk" );
    cr.SetEvent( CRITTER_EVENT_SHOW_CRITTER, "_Arcade_sight" );
}

void _Arcade_sight( Critter& cr, Critter& showCr )
{
    Map@ map = cr.GetMap();
    Critter@[] critters;
    if( showCr.IsPlayer() && showCr.ParamBase[ QST_GAMEMODE ] == GAME_START && ( map.GetCrittersHex( cr.HexX, cr.HexY, 15, FIND_LIFE_AND_KO | FIND_ONLY_PLAYERS, critters ) <= 1 ) )
    {
        uint16[] ArcadeSkins = { 15, 16, 19, 22, 23, 24, 25, 51, 52, 55, 58, 59, 60, 65, 67, 68, 80, 81, 86, 97 };
        cr.ChangeCrType( ArcadeSkins[ Random( 0, ArcadeSkins.length() ) ] );
    }
}

bool _ArcadeKindman_talk( Critter& player, Critter& talkCr, bool attach, uint talkCount ) // выбор режима игры
{
    if( talkCr.Param[ QST_GAMEMODE ] == GAME_START )
    {
        talkCr.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_ArcadeKindman_talk" );
        talkCr.Say( SAY_DIALOGBOX_TEXT, "НПЦ стоит временно без диалога" );
        talkCr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Войти в игру аркадой" );
        talkCr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Постоять пока тут" );
        return false;
    }
    else
        talkCr.Say( SAY_NETMSG, "Ошибка, обратитесь к ГеймМастерам." );
    return false;
}

void answer_ArcadeKindman_talk( Critter& player, uint answerI, string& answerS )
{
    if( player.Param[ QST_GAMEMODE ] != GAME_START )
        return;
    if( answerI == 0 )
    {
        Map@ start = GetMapByPid( MAP_UTILITY_START, 0 );
        _crOut( start, player );
        unsafe_arcade( player, 0, 0, 0, null, null );
    }
}

void _SurvivalKindmanInit( Critter& cr, bool firstTime )
{
    cr.StatBase[ ST_DIALOG_ID ] = 331;   // нпц_гайд
    cr.ModeBase[ MODE_NO_WALK ] = 1;
    cr.ModeBase[ MODE_NO_RUN ] = 1;
    cr.ModeBase[ MODE_NO_STEAL ] = 1;
    cr.ModeBase[ MODE_NO_PVP ] = 1;
    cr.ModeBase[ MODE_INVULNERABLE ] = 1;
    cr.ModeBase[ MODE_NO_PUSH ] = 1;
    cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 1;
    cr.ModeBase[ MODE_NO_UNARMED ] = 1;
    cr.ParamBase[ QST_INVIS ] = 40;
    cr.SetEvent( CRITTER_EVENT_TALK, "_SurvivalKindman_talk" );
    cr.SetEvent( CRITTER_EVENT_SHOW_CRITTER, "_Survival_sight" );
}

bool _SurvivalKindman_talk( Critter& kindman, Critter& player, bool attach, uint talkCount ) // выбор режима игры
{
    if( player.ParamBase[ QST_GAMEMODE ] != GAME_START )
        return false;
	
	Item@[] items;
	player.GetItems( SLOT_ARMOR, items );
	player.GetItems( SLOT_HAND1, items );
	player.GetItems( SLOT_HAND2, items );
	player.GetItems( SLOT_INV, items );
	
	DeleteItems( items );
	
	player.ParamBase[ QST_GAMEMODE ] = GAME_SURVIVAL;
	kind_tele2( player, null, 252 );
	return false;
}

void answer_SurvivalKindman_talk( Critter& player, uint answerI, string& answerS )
{
    if( player.ParamBase[ QST_GAMEMODE ] != GAME_START )
        return;
    if( answerI == 0 )
    {
        player.ParamBase[ QST_GAMEMODE ] = GAME_SURVIVAL;
        uint LocPid = 252;

        kind_tele2( player, null, LocPid );
    }
}

void _Survival_sight( Critter& cr, Critter& showCr )
{
    Map@ map = cr.GetMap();
    Critter@[] critters;
    if( showCr.IsPlayer() && showCr.ParamBase[ QST_GAMEMODE ] == GAME_START && ( map.GetCrittersHex( cr.HexX, cr.HexY, 15, FIND_LIFE_AND_KO | FIND_ONLY_PLAYERS, critters ) <= 1 ) )
    {
        uint16[] GMskins =
        {
            0, 1, 2, 3, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 20, 21, 26, 27, 28, 29, 31, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 48, 53, 57, 61, 62, 63, 64, 66,
            69, 71, 72, 73, 74, 75, 76, 77, 78, 79, 82, 83, 85, 87, 88, 91, 94, 95, 96, 99, 103, 110, 120
        };
        cr.ChangeCrType( GMskins[ Random( 0, GMskins.length() ) ] );
    }
}

void _InitStartGM( Critter& cr, bool firstTime ) // самый стартовый нпц
{
    cr.StatBase[ ST_PERCEPTION ] = 10;
    cr.StatBase[ ST_DIALOG_ID ] = 331;           // нпц_гайд
    cr.ShowCritterDist1 = 15;
    cr.ModeBase[ MODE_NO_WALK ] = 1;
    cr.ModeBase[ MODE_NO_RUN ] = 1;
    cr.ModeBase[ MODE_NO_STEAL ] = 1;
    cr.ModeBase[ MODE_NO_PVP ] = 1;
    cr.ModeBase[ MODE_INVULNERABLE ] = 1;
    cr.ModeBase[ MODE_NO_PUSH ] = 1;
    cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 1;
    cr.ModeBase[ MODE_NO_UNARMED ] = 1;
    cr.ParamBase[ QST_INVIS ] = 40;
    cr.SetEvent( CRITTER_EVENT_TALK, "_StartGM_talk" );
    cr.SetEvent( CRITTER_EVENT_SHOW_CRITTER, "_StartGM_sight" );
}

void _StartGM_sight( Critter& cr, Critter& showCr )
{
    Map@ map = cr.GetMap();
    Critter@[] critters;
    if( showCr.IsPlayer() && showCr.ParamBase[ QST_GAMEMODE ] == GAME_START && ( map.GetCrittersHex( cr.HexX, cr.HexY, 15, FIND_LIFE_AND_KO | FIND_ONLY_PLAYERS, critters ) <= 1 ) )
    {
        uint16[] GMskins =
        {
            0, 1, 2, 3, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 20, 21, 26, 27, 28, 29, 31, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 48, 53, 57, 61, 62, 63, 64, 66,
            69, 71, 72, 73, 74, 75, 76, 77, 78, 79, 82, 83, 85, 87, 88, 91, 94, 95, 96, 99, 103, 110, 120
        };
        cr.ChangeCrType( GMskins[ Random( 0, GMskins.length() ) ] );
    }
}

bool _StartGM_talk( Critter& player, Critter& talkCr, bool attach, uint talkCount ) // выбор режима игры
{
	ShowStartVars( talkCr );
	return false;
}

void ShowStartVars( Critter& player )
{
    if( player.ParamBase[ QST_GAMEMODE ] == GAME_START )
    {
		bool isMale = player.Stat[ ST_GENDER ] == GENDER_MALE;
        player.ShowScreen( SCREEN_DIALOGBOX, 4 + ( isMale? 1 : 0 ), "answer_StartGM_talk" );
        player.Say( SAY_DIALOGBOX_TEXT, "Добро пожаловать в игру!" + ( isMale ? "Или выберите длинну волос." : "" ) );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Информация (сайт)" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Начать игру" );
		player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Изменить скин" );
		player.Say( SAY_DIALOGBOX_BUTTON( 3 ), isMale ? "Рост волос" : "Цвет волос" );
		if( isMale )
			player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "Цвет кожи" );
    }
    else
        player.Say( SAY_NETMSG, "Ошибка, обратитесь к ГеймМастерам." );
}

void answer_StartGM_talk( Critter& player, uint answerI, string& answerS )
{
    if( answerI == 0 )
	{
		/*
        Location @ loc = GetLocationByPid( LOCATION_Bridge, 0 );
        Map @ map = loc.GetMapByIndex( 0 );
        Map@ start = GetMapByPid( MAP_UTILITY_START, 0 );
        player.Say( SAY_NETMSG, "Вы выбрали режим обучения." );
        _crOut( start, player );
        player.TransitToMap( map.Id, 0 );
		*/	
		OpenLinkRemote(player, "http://frp.su");
	}
	
	else if( answerI == 1 )
    {
		uint count = player.CountItem(  PID_SKIN_CHANGER );
		if( count > 0 )
			player.DeleteItem( PID_SKIN_CHANGER, count );

        bool tele = false;
        tele = player.TransitToHex( 305 + Random( -3, 3 ), 240 + Random( -3, 3 ), 0 ); // к кайнду выживания
        if( !tele )
            player.Say( SAY_NETMSG, "Попробуйте еще раз." );
        else
            player.Say( SAY_NETMSG, "Вы выбрали режим выживания." );
    }
	
    else if( answerI == 2 )
    {
		if( player.CountItem(  PID_SKIN_CHANGER ) < 1 )
			player.AddItem( PID_SKIN_CHANGER, 1 );
		player.Say( SAY_NETMSG, "Предмет для смены скинов появился к кармане. Что бы сбросить скин позже в игре пишите ~naked, сейчас можно просто снова использовать косметичку. Что бы изменить описание персонажа - скажите ~lex \"текст\", без кавычек." );
	}
	
	else if( answerI == 3 ) //Считается, что сюда женские персонажи не зайдут, т.к. им не выводится данный пункт меню.
	{	//player.Stat[ ST_GENDER ] == GENDER_MALE
		if( player.Stat[ ST_GENDER ] == GENDER_MALE )
		{
			int[] types = { 120, 62, 110 };
			int index = types.find( player.Stat[ ST_BASE_CRTYPE ] );
			if( player.Stat[ ST_BASE_CRTYPE ] == 0 || index == -1 ) index = 62;
			if( index > -1 )
			{
				index = types[ ( index + 1 ) % types.length() ];
				player.ParamBase[ ST_BASE_CRTYPE ] = index;
				player.ChangeCrType( index );
			}
			else
				player.Say( SAY_NETMSG, "Так отращивать волосы можно лишь голым дикарям. Остальные скины и причёски доступны через косметичку." );
			ShowStartVars( player );
		}
		else
		{
			int[] types = { 151, 61 };
			int index = types.find( player.Stat[ ST_BASE_CRTYPE ] );
			if( player.Stat[ ST_BASE_CRTYPE ] == 0 || index == -1 ) index = 61;
			if( index > -1 )
			{
				index = types[ ( index + 1 ) % types.length() ];
				player.ParamBase[ ST_BASE_CRTYPE ] = index;
				player.ChangeCrType( index );
			}
			else
				player.Say( SAY_NETMSG, "Так менять цвет кожи можно лишь голым дикарям. Остальные скины и причёски доступны через косметичку." );
			ShowStartVars( player );
		}
	}
	
	else if( answerI == 4 )
	{
		int[] types = { 62, 140 };
		int index = types.find( player.Stat[ ST_BASE_CRTYPE ] );
		if( player.Stat[ ST_BASE_CRTYPE ] == 0 || index == -1 ) index = 62;
		if( index > -1 )
		{
			index = types[ ( index + 1 ) % types.length() ];
			player.ParamBase[ ST_BASE_CRTYPE ] = index;
			player.ChangeCrType( index );
		}
		else
			player.Say( SAY_NETMSG, "Так менять цвет кожи можно лишь голым дикарям. Остальные скины и причёски доступны через косметичку." );
		ShowStartVars( player );
	}

}

void _InitAdventureGM( Critter& cr, bool firstTime ) // нпц приключенцев
{
    cr.StatBase[ ST_DIALOG_ID ] = 331;               // нпц_гайд
    cr.ModeBase[ MODE_NO_WALK ] = 1;
    cr.ModeBase[ MODE_NO_RUN ] = 1;
    cr.ModeBase[ MODE_NO_STEAL ] = 1;
    cr.ModeBase[ MODE_NO_PVP ] = 1;
    cr.ModeBase[ MODE_INVULNERABLE ] = 1;
    cr.ModeBase[ MODE_NO_PUSH ] = 1;
    cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 1;
    cr.ModeBase[ MODE_NO_UNARMED ] = 1;
    cr.ParamBase[ QST_INVIS ] = 40;
    cr.SetEvent( CRITTER_EVENT_TALK, "_StartAdventureGM_talk" );
    // cr.SetEvent(CRITTER_EVENT_SHOW_CRITTER, "_StartAdventureGM_sight");
}

void _StartAdventureGM_sight( Critter& cr, Critter& showCr )
{
    Map@ map = cr.GetMap();
    Critter@[] critters;
    if( showCr.IsPlayer() && showCr.ParamBase[ QST_GAMEMODE ] == GAME_START && ( map.GetCrittersHex( cr.HexX, cr.HexY, 15, FIND_LIFE_AND_KO | FIND_ONLY_PLAYERS, critters ) <= 1 ) )
    {
        uint16[] GMskins =
        {
            0, 1, 2, 3, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 20, 21, 26, 27, 28, 29, 31, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 48, 53, 57, 61, 62, 63, 64, 66,
            69, 71, 72, 73, 74, 75, 76, 77, 78, 79, 82, 83, 85, 87, 88, 91, 94, 95, 96, 99, 103, 110, 120
        };
        cr.ChangeCrType( GMskins[ Random( 0, GMskins.length() ) ] );
    }
}


bool _StartAdventureGM_talk( Critter& player, Critter& talkCr, bool attach, uint talkCount ) // выбор режима игры
{
    GameVar@ activation = GetLocalVar( LVAR_activationStatus, talkCr.Id );
    GameVar@ request = GetLocalVar( LVAR_requestStatus, talkCr.Id );

    if( talkCr.ParamBase[ QST_GAMEMODE ] == GAME_START )
    {
        if( activation.GetValue() > request.GetValue() )
        {
            talkCr.ShowScreen( SCREEN_DIALOGBOX, 3, "answer_StartAdventureGM_activ" );
            talkCr.Say( SAY_DIALOGBOX_TEXT, "Вы АКТИВИРОВАННЫ" );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "В Модок" );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "В Саттер" );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Править чарлист" );
        }
        else if( activation.GetValue() == -1 )
        {
            talkCr.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_unactiv" );
            talkCr.Say( SAY_DIALOGBOX_TEXT, "Вам отказанно в активации и скорее всего повторно рассматривать не будут." );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Править чарлист" );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Оставить как есть" );
        }
        else if( talkCr.ParamBase[ ST_VAR8 ] != 0 )
        {
            talkCr.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_unactiv" );
            talkCr.Say( SAY_DIALOGBOX_TEXT, "Вы уже подтвердили выбор, правки отзовут реквест активации." );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Править чарлист" );
            talkCr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Оставить как есть" );
        }
        else
        {
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
        }
        return false;
    }
    else
        talkCr.Say( SAY_NETMSG, "Ошибка, обратитесь к ГеймМастерам." );
    return false;
}

void answer_StartAdventureGM_activ( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 0 )
    {
        player.ParamBase[ QST_GAMEMODE ] = GAME_ADVENTURE;
        GameVar@ citizenship = GetLocalVar( LVAR_modoc_citizenship, player.Id );
        if( citizenship.GetValue() == 11 )
            citizenship.opAssign( 2 );
        else if( citizenship.GetValue() == 12 )
            citizenship.opAssign( 3 );
        else if( citizenship.GetValue() == 13 )
        {
            citizenship.opAssign( 2 );
            player.ParamBase[ QST_GAMEMODE ] = GAME_SURVIVAL;
        }
        else
            citizenship.opAssign( 0 );
        if( citizenship.GetValue() == 3 )
        {
            Item@   pass = player.AddItem( PID_MODOC_DOCUMENTS, 1 );
            string@ name = GetPlayerName( player.Id );
            pass.SetLexems( "$ModocRegistrationName" + name );
        }
        kind_tele2( player, null, LOCATION_Sutter_4_1 );
    }
    if( answerI == 1 )
    {
        player.ParamBase[ QST_GAMEMODE ] = GAME_ADVENTURE;
        GameVar@ citizenship = GetLocalVar( LVAR_modoc_citizenship, player.Id );
        if( citizenship.GetValue() == 11 )
            citizenship.opAssign( 2 );
        else if( citizenship.GetValue() == 12 )
            citizenship.opAssign( 3 );
        else if( citizenship.GetValue() == 13 )
        {
            citizenship.opAssign( 2 );
            player.ParamBase[ QST_GAMEMODE ] = GAME_SURVIVAL;
        }
        else
            citizenship.opAssign( 0 );
        if( citizenship.GetValue() == 3 )
        {
            Item@   pass = player.AddItem( PID_MODOC_DOCUMENTS, 1 );
            string@ name = GetPlayerName( player.Id );
            pass.SetLexems( "$ModocRegistrationName" + name );
        }
        kind_tele2( player, null, LOCATION_Sutter_4_1 );
    }
    if( answerI == 2 )
    {
        GameVar@ request = GetLocalVar( LVAR_requestStatus, player.Id );
        request.opAddAssign( 1 );
        player.ParamBase[ ST_VAR8 ] = 0;
        file f;
        if( f.open( "adventurers\\" + player.Id + ".txt", "w" ) >= 0 )
        {
            f.close();
        }
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}

void answer_StartAdventureGM_unactiv( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 0 )
    {
        file f;
        if( f.open( "adventurers\\" + player.Id + ".txt", "w" ) >= 0 )
        {
            f.close();
        }
        GameVar@ request = GetLocalVar( LVAR_requestStatus, player.Id );
        request.opAddAssign( 1 );
        player.ParamBase[ ST_VAR8 ] = 0;
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}

import void DIALOG_MENU( Critter& cr, string[] data ) from "gm";

import void StoreMenu( Critter& cr ) from "store";

string[] stat_names = { "легкое", "тяжелое", "энерго", "рукопашная", "холодное", "метательное", "санитар", "доктор", "скрытность", "взлом", "кража", "ловушки", "наука", "ремонт", "разговор", "торговля", "игра", "скиталец" };
void answer_StartAdventureGM_talk( Critter& player, uint answerI, string& answerS )
{
   if( player is null )
        return;
    if( answerI == 0 )
    {
		string[] data = { "answer_StartAdventureGM_talk_STATS_SKILL", "Навыки игрока, осталось " + player.ParamBase[ ST_VAR7 ] + " очков навыков" };
		for( int i = 200; i < 218; i++ )
		{
			data.insertLast( "[" + player.ParamBase[ i ] + " " + stat_names[i - 200] );
		}
		DIALOG_MENU( player, data );
    }
    if( answerI == 1 )
    {
		StoreMenu( player );
    }
    if( answerI == 2 )
    {
        ShowInputBoxScreen( player, "map_start@unsafe_Description#Описание, приметы", 0, INPUTBOX_CLOSE_ON_ENTER );
    }
    if( answerI == 3 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_CONFIRM" );
        player.Say( SAY_DIALOGBOX_TEXT, "Вы уверены в своем выборе?" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Да, абсолютно" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Нет." );
    }
}

void answer_StartAdventureGM_talk_HELP( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 0 )
    {
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}



import void GM_SPAWN( Critter& player, Map& map, int type, int weapon, int AI_type, uint16 hexX, uint16 hexY, int bonus_hp, int bonus_dmg, int bonus_skill ) from "gm";
import void ChangeStatus( Critter& cr, uint16 status, uint8 value, bool set ) from "critter_status";

import void FullHeal( Critter& cr ) from "gm";

void answer_StartAdventureGM_talk_STATS( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 1 )
    {
	}
    if( answerI == 3 )
    {
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}

void ask_StartAdventureGM_talk_STATS_SPECIAL( Critter& player, uint answerI, string& answerS )
{
    int parameter = player.Stat[ ST_VAR1 ];
    if( !valid( player ) )
        return;
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
        if( parameter >= 0 && parameter <= 6 )
        {
            if( number > 10 || number < 1 )
                player.Say( SAY_NETMSG, "недопустимое значение" );
            else if( player.ParamBase[ ST_VAR6 ] - number + player.ParamBase[ parameter ] < 0 )
                player.Say( SAY_NETMSG, "недоcтаточно очков" );
            else
            {
                player.ParamBase[ ST_VAR6 ] -= number - player.ParamBase[ parameter ];
                player.ParamBase[ parameter ] = number;
                player.Say( SAY_NETMSG, "вы изменили параметр" );
            }
        }
        if( parameter >= 200 && parameter <= 217 )
        {
            if( number > 300 )
                player.Say( SAY_NETMSG, "недопустимое значение" );
            else if( number < 30 )
                player.Say( SAY_NETMSG, "нельзя указывать значение навыка меньше 30" );
            else if( player.ParamBase[ ST_VAR7 ] - number + player.ParamBase[ parameter ] < 0 )
                player.Say( SAY_NETMSG, "недоcтаточно очков навыков" );
            else
            {
                player.ParamBase[ ST_VAR7 ] -= number - player.ParamBase[ parameter ];
                player.ParamBase[ parameter ] = number;
                player.Say( SAY_NETMSG, "вы изменили параметр" );
            }
        }
        if( parameter == 3 && player.ParamBase[ parameter ] <= 3 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_STATS_SPECIAL_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "к персонажам с низкой харизмой другие игроки относятся с неприязнью, убедитесь что это соответствует роли" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter >= 0 && parameter <= 6 && ( player.ParamBase[ parameter ] >= 9 || player.ParamBase[ parameter ] <= 2 ) )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "значение параметра граничное, убедитесь что это важно по роли, иначе активация маловероятна" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter == 211 && player.ParamBase[ parameter ] >= 50 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "навык ловушек больше 50, убедитесь что по роли вам это необходимо и история персонажа соответствует, иначе активация маловероятна" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter == 210 && player.ParamBase[ parameter ] >= 50 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "воровство больше 50, убедитесь что по роли вам это необходимо и история персонажа соответствует, иначе активация маловероятна" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter == 209 && player.ParamBase[ parameter ] >= 50 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "взлом больше 50, допустим только для ролей преступников и детективов, убедитесь что персонаж соответствует, иначе активация маловероятна" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter == 212 && player.ParamBase[ parameter ] >= 80 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "значение науки больше 80, допустимо только для образованных персонажей, убедитесь что роль соответствует" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter == 213 && player.ParamBase[ parameter ] >= 80 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "значение ремонта больше 80, допустимо только для профильных персонажей, часто занимающихся техникой, убедитесь что роль соответствует" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter >= 200 && parameter <= 217 && player.ParamBase[ parameter ] >= 160 )
        {
            player.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_StartAdventureGM_talk_POWERBUILD" );
            player.Say( SAY_DIALOGBOX_TEXT, "значение навыка больше 160, допустимо только для узкоспециализированных в этой области персонажей, убедитесь что роль соответствует" );
            player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "к параметрам" );
        }
        else if( parameter >= 200 && parameter <= 217 )
        {
			string[] data = { "answer_StartAdventureGM_talk_STATS_SKILL", "Навыки игрока, осталось " + player.ParamBase[ ST_VAR7 ] + " очков навыков" };
			for( int i = 200; i < 218; i++ )
			{
				data.insertLast( "[" + player.ParamBase[ i ] + " " + stat_names[i - 200] );
			}
			DIALOG_MENU( player, data );
		}
    }
}

void answer_StartAdventureGM_talk_POWERBUILD( Critter& player, uint answerI, string& answerS )
{
	string[] data = { "answer_StartAdventureGM_talk_STATS_SKILL", "Навыки игрока, осталось " + player.ParamBase[ ST_VAR7 ] + " очков навыков" };
	for( int i = 200; i < 218; i++ )
	{
		data.insertLast( "[" + player.ParamBase[ i ] + " " + stat_names[i - 200] );
	}
	DIALOG_MENU( player, data );
}


void answer_StartAdventureGM_talk_STATS_SKILL( Critter& player, uint answerI, string& answerS )
{
	player.ParamBase[ ST_VAR1 ] = 200 + answerI;
	player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
	player.Say( SAY_SAY_TITLE, stat_names[answerI] );
}

void answer_StartAdventureGM_talk_STATS_SPECIAL( Critter& player, uint answerI, string& answerS )
{
    if( answerI == 0 )
    {
        player.ParamBase[ ST_VAR1 ] = 0;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Сила" );
    }
    if( answerI == 1 )
    {
        player.ParamBase[ ST_VAR1 ] = 1;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Восприятие" );
    }
    if( answerI == 2 )
    {
        player.ParamBase[ ST_VAR1 ] = 2;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Выносливость" );
    }
    if( answerI == 3 )
    {
        player.ParamBase[ ST_VAR1 ] = 3;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Харизма" );
    }
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = 4;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Интеллект" );
    }
    if( answerI == 5 )
    {
        player.ParamBase[ ST_VAR1 ] = 5;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Ловкость" );
    }
    if( answerI == 6 )
    {
        player.ParamBase[ ST_VAR1 ] = 6;
        player.ShowScreen( SCREEN_SAY, 0, "map_start@ask_StartAdventureGM_talk_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "Удача" );
    }
    if( answerI == 7 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 3, "answer_StartAdventureGM_talk_STATS" );
        player.Say( SAY_DIALOGBOX_TEXT, "Параметры игрока" );
//        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "SPECIAL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "SKILLS 0-9" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "SKILLS 10-20" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Назад" );
    }
}

void unsafe_Description( Critter& player, int skill, int p1, int p2, string@ message, int[] @ p4 )
{
    if( message.length() != 0 )
    {
        player.SetLexems( message );
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}

void answer_StartAdventureGM_talk_CONFIRM( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 0 )
    {
        ShowInputBoxScreen( player, "map_start@unsafe_Kventa#Ссылка на квенту", 0, INPUTBOX_CLOSE_ON_ENTER );
    }
}

void unsafe_Kventa( Critter& player, int skill, int p1, int p2, string@ message, int[] @ p4 )
{
    if( message.length() != 0 )
    {
        Item@[] allitems;
        player.GetItems( -1, allitems );

        string date = TimeToString( player );
        string race = "";
        player.ParamBase[ ST_VAR8 ] = 1;
        if( player.ParamBase[ ST_BODY_TYPE ] == BT_GHOUL )
            race = "Гуль";
        else if( player.ParamBase[ ST_BODY_TYPE ] == BT_SUPER_MUTANT )
            race = "Супермутант";
        else
            race = "Человек";
        string   pass = "";
        GameVar@ citizenship = GetLocalVar( LVAR_modoc_citizenship, player.Id );
        if( citizenship.GetValue() == 0 )
            pass = "чужак";
        else if( citizenship.GetValue() == 11 )
            pass = "гость";
        else if( citizenship.GetValue() == 12 )
            pass = "гражданин";
        GameVar@ request = GetLocalVar( LVAR_requestStatus, player.Id );
        GameVar@ TotalPlayers = GetGlobalVar( GVAR_total_players ); // общее число персонажей
        if( TotalPlayers.GetValue() < int( player.Id ) )
            TotalPlayers.opAssign( player.Id );
        request.opAddAssign( 1 );
        file f;
        if( f.open( "adventurers\\" + player.Id + ".txt", "w" ) >= 0 )
        {
            f.writeString( request.GetValue() + "\n" +
                           race + "\n" +
                           date + "  -  " + pass + "\n" +
                           GetPlayerName( player.Id ) + "\n" +
                           message + "\n" +
                           player.ParamBase[ 0 ] + "\n" +
                           player.ParamBase[ 1 ] + "\n" +
                           player.ParamBase[ 2 ] + "\n" +
                           player.ParamBase[ 3 ] + "\n" +
                           player.ParamBase[ 4 ] + "\n" +
                           player.ParamBase[ 5 ] + "\n" +
                           player.ParamBase[ 6 ] + "\n" + "\n" +
                           player.ParamBase[ 200 ] + "\n" +
                           player.ParamBase[ 201 ] + "\n" +
                           player.ParamBase[ 202 ] + "\n" +
                           player.ParamBase[ 203 ] + "\n" +
                           player.ParamBase[ 204 ] + "\n" +
                           player.ParamBase[ 205 ] + "\n" +
                           player.ParamBase[ 206 ] + "\n" +
                           player.ParamBase[ 207 ] + "\n" +
                           player.ParamBase[ 208 ] + "\n" +
                           player.ParamBase[ 209 ] + "\n" +
                           player.ParamBase[ 210 ] + "\n" +
                           player.ParamBase[ 211 ] + "\n" +
                           player.ParamBase[ 212 ] + "\n" +
                           player.ParamBase[ 213 ] + "\n" +
                           player.ParamBase[ 214 ] + "\n" +
                           player.ParamBase[ 215 ] + "\n" +
                           player.ParamBase[ 216 ] + "\n" +
                           player.ParamBase[ 217 ] + "\n" + "\n" + "Инвентарь" + "\n" );

            Item@[] items;
            player.GetItems( SLOT_ARMOR, items );
            player.GetItems( SLOT_HAND1, items );
            player.GetItems( SLOT_HAND2, items );
            player.GetItems( SLOT_INV, items );
            for( uint i = 0; i < items.length(); i++ )
            {
                f.writeString( items[ i ].GetCount() + "\n" );
                f.writeString( items[ i ].GetProtoId() + "\n" );
            }
			f.writeString( 12345 + "\n" );
            f.close();
        }
    }
}

void answer_StartAdventureGM_talk_MODOC( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    GameVar@ citizenship = GetLocalVar( LVAR_modoc_citizenship, player.Id );
    if( answerI == 0 )
    {
        citizenship.opAssign( 0 );
        player.Say( SAY_NETMSG, "Теперь вы чужой в Модоке." );
    }
    if( answerI == 1 )
    {
        citizenship.opAssign( 11 );
        player.Say( SAY_NETMSG, "Теперь вы гость в Модоке." );
    }
    if( answerI == 2 )
    {
        citizenship.opAssign( 12 );
        player.Say( SAY_NETMSG, "Теперь вы гражданин Модока." );
    }
}

void answer_StartAdventureGM_talk_RACE( Critter& player, uint answerI, string& answerS )
{
    if( player is null )
        return;
    if( answerI == 0 )
    {
        Item@[] items;
        player.GetItems( SLOT_ARMOR, items );
        player.GetItems( SLOT_HAND1, items );
        player.GetItems( SLOT_HAND2, items );
        DeleteItems( items );
        player.StatBase[ ST_MUTATION ] = 0;
        player.StatBase[ ST_MAX_LIFE ] = 0;
        player.ParamBase[ PE_STRONG_BACK ] = 0;
        if( player.Stat[ ST_GENDER ] == GENDER_MALE )
        {
            player.ParamBase[ ST_BODY_TYPE ] = BT_MEN;
            player.ChangeCrType( 69 );
        }
        else
        {
            player.ParamBase[ ST_BODY_TYPE ] = BT_WOMEN;
            player.ChangeCrType( 74 );
        }
        player.StatBase[ ST_BASE_CRTYPE ] = 0;
        player.Say( SAY_NETMSG, "Теперь вы выглядите...  нормально." );

    }
    if( answerI == 1 )
    {
        Item@[] items;
        player.GetItems( SLOT_ARMOR, items );
        player.GetItems( SLOT_HAND1, items );
        player.GetItems( SLOT_HAND2, items );
        DeleteItems( items );
        player.StatBase[ ST_MUTATION ] = 3;
        player.StatBase[ ST_MAX_LIFE ] = 100;
        player.ParamBase[ PE_STRONG_BACK ] = 0;
        player.ParamBase[ ST_BODY_TYPE ] = BT_GHOUL;
        player.ChangeCrType( 28 );
        player.StatBase[ ST_BASE_CRTYPE ] = 28;
        player.Say( SAY_NETMSG, "Теперь вы выглядите...  страннее." );
    }
    if( answerI == 2 )
    {
        Item@[] items;
        player.GetItems( SLOT_ARMOR, items );
        player.GetItems( SLOT_HAND1, items );
        player.GetItems( SLOT_HAND2, items );
        DeleteItems( items );
        player.StatBase[ ST_MUTATION ] = 3;
        player.StatBase[ ST_MAX_LIFE ] = 100;
        player.ParamBase[ PE_STRONG_BACK ] = 0;
        player.ParamBase[ ST_BODY_TYPE ] = BT_GHOUL;
        player.ChangeCrType( 79 );
        player.StatBase[ ST_BASE_CRTYPE ] = 79;
        player.Say( SAY_NETMSG, "Теперь вы выглядите...  страннее." );
    }
    if( answerI == 3 )
    {
        Item@[] items;
        player.GetItems( SLOT_ARMOR, items );
        player.GetItems( SLOT_HAND1, items );
        player.GetItems( SLOT_HAND2, items );
        DeleteItems( items );
        player.StatBase[ ST_MUTATION ] = 3;
        player.StatBase[ ST_MAX_LIFE ] = 100;
        player.ParamBase[ PE_STRONG_BACK ] = 0;
        player.ParamBase[ ST_BODY_TYPE ] = BT_GHOUL;
        player.ChangeCrType( 29 );
        player.StatBase[ ST_BASE_CRTYPE ] = 29;
        player.Say( SAY_NETMSG, "Теперь вы выглядите...  страннее." );
    }
    if( answerI == 4 )
    {
        Item@[] items;
        player.GetItems( SLOT_ARMOR, items );
        player.GetItems( SLOT_HAND1, items );
        player.GetItems( SLOT_HAND2, items );
        DeleteItems( items );
        player.StatBase[ ST_MUTATION ] == 3;
        player.StatBase[ ST_MAX_LIFE ] = 100;
        player.ParamBase[ PE_STRONG_BACK ] = 3;
        player.ParamBase[ ST_BODY_TYPE ] = BT_SUPER_MUTANT;
        player.ChangeCrType( 21 );
        player.StatBase[ ST_BASE_CRTYPE ] = 21;
        player.Say( SAY_NETMSG, "Теперь вы выглядите...  сильнее." );
    }
    if( answerI == 5 )
    {
		string[] data = { "answer_StartAdventureGM_talk", "Выберите опцию:", "SKILLS", "Склад", "Описание", "Подтвердить" };
		DIALOG_MENU( player, data );
    }
}

void r_toHex( Critter& master, Critter@ slave, int val )
{
    Map@ map = master.GetMap();

    if( map is null )
        return;

    uint16 hexX = 0, hexY = 0;

    if( !map.GetEntireCoords( val, 0, hexX, hexY ) )
        return;

    master.TransitToHex( hexX, hexY, 5 );
}

void kind_tele2( Critter& master, Critter@ slave, int val )
{
    if( not valid( master ) )
        return;

    Location @ loc = GetLocationByPid( val, 0 );  // modoc entrance
    if( not valid( loc ) )
    {
        slave.Say( SAY_NETMSG, "Location not found" );
        return;
    }

	Map @ map = loc.GetMapByIndex(0);
    if( not valid( map ) )
    {
        master.Say( SAY_NETMSG, "Map index not found" );
        return;
    }
	
	if( master.ParamBase[ QST_GAMEMODE ] == GAME_ADVENTURE )
	{
		file f;
		if( f.open( "adventurers\\" + master.Id + ".txt", "r" ) >= 0 )
		{
			Item@ item;		
			string text = "";
			uint   pos = 0;
			uint   line = 0;
			int    number = 0;
			int    count = 0;	
			bool   isCount = true;
			f.setPos( 0 );
			while( !f.isEndOfFile() )
			{
				line ++;
				f.readLine( text );
				text.resize( text.length() - 1 );
				StrToInt( text, number );
				if( line >= 6 && line <= 12)
				{
					master.ParamBase[ line - 6] = number;
				}
				else if( line >= 14 && line <= 31 )
				{
					master.ParamBase[ line + 186 ] = number;
				}
				else if( line >= 34 )
				{
					Log("line="+line+" , num="+number);				
					if( number == 12345 ) break;
					if( isCount )
						{
						count = number;
						isCount = false;
						}
					else
					{
						@ item = master.AddItem( number, count );
						if( item.AmmoCount != 0 ) item.AmmoCount = 0;
						isCount = true;
					}
				}
			}
			f.close();
		}
		else return;
    }
	
    master.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( ( Random( 0, 1 ) == 1 ) ), 200, master.HexX, master.HexY );

    master.SetEvent( CRITTER_EVENT_USE_ITEM, null );
    master.SetEvent( CRITTER_EVENT_DROP_ITEM, null );
    master.SetEvent( CRITTER_EVENT_ATTACK, null );
    master.SetEvent( CRITTER_EVENT_DEAD, null );	
		
	if( loc.GetProtoId() == 252 ) //Сессия №4: ЭД
	{
		master.TransitToMap( map.Id, 250, Random( 130, 150 ), 0 );
		master.Say( SAY_NETMSG, "|0xFFFF00Вы набрели на дорогу: на севере виднеется свалка, на юге город, на северо-востоке - большая гора... " );
		return;
	}

	if( loc.GetProtoId() == 22 ) //Сессия №3:
	{
		master.TransitToMap( map.Id, Random( 151, 201 ), 259, 0 );
		master.Say( SAY_NETMSG, "|0xFFFF00Ваши странствия привели вас в живописный край: слева простирается густой лес, справа - руины какого-то города, на северо-востоке виднеется огромная гора..." );
		return;
	}
	
	if( loc.GetProtoId() == 108 ) //Сессия №2:
	{
		master.TransitToMap( map.Id, Random( 151, 201 ), 259, 0 );
		master.Say( SAY_NETMSG, "Вы наконец добрались до перевалочного лагеря в руинах округа Сан-Франциско. Пирс должен находиться поблизости." );
		return;
	}
	
    if( loc.GetProtoId() == 25 ) //Форт, Сессия №1:
	{
		uint16 x = 0, y = 0;
		switch( Random( 1, 3 ) )
		{
			case( 1 ):
				x = 605;
				y = Random( 209, 505 );
			break;
			case( 2 ):
				x = Random( 307, 605 );
				y = 505;
			break;
			case( 3 ):
				x = 307;
				y = Random( 207, 505 );
			break;
			default: break;
		}
		master.TransitToMap( map.Id, x, y, 0 );
		master.Say( SAY_NETMSG, "Вы наконец добрались до центрального квартала Саттера. Форт должен находиться в самом центре, это ЖД станция." );
		
		/* //Отключил по просьбам трудящихся.
		if( master.Stat[ ST_BASE_CRTYPE ] == 62 || master.Stat[ ST_BASE_CRTYPE ] == 0 || master.Stat[ ST_BASE_CRTYPE ] == 61 )
		{
			uint[] data = { master.Id };
			CreateTimeEvent( __FullSecond + REAL_SECOND( 1 ), "e_randomSkin", data, true );
		}
		*/
		return;
	}
	/*
	uint16 hexX = 0, hexY = 0, hexX0 = 0, hexY0 = 0;
	map.GetEntireCoords( 255, 0, hexX0, hexY0 );
	
	for( uint i = 0; i < 10; i++ )
	{
		hexX = hexX0 + ( Random( 0, 2 ) - 1 ) * Random( 0, 100 );
		hexY = hexY0 + ( Random( 0, 2 ) - 1 ) * Random( 0, 100 );
		if( map.GetCrittersHex( hexX, hexY, 10, FIND_LIFE | FIND_ONLY_NPC, null ) == 0 ) break;
	}
	*/
}

uint e_randomSkin( uint[] @ values )
{
	if(!valid(values)) return 0;
	
	Critter@ cr = GetCritter(values[0]);
	if(!valid(cr)) return 0;
	
    RadomSkin( cr );
	
    return 0;
}


uint[][] skins = { //Это ужос.. знаю, знаю. Но что поделаешь..
	{ 13 },
	{ 6 }
};

uint[][] naked_skins = { //Это ужос.. знаю, знаю. Но что поделаешь..
	{ 12, 13, 31, 39, 40, 41, 44, 45, 48, 57, 62, 64, 69, 82, 88, 89, 91, 92, 93, 106, 107, 108, 110, 116, 117, 118, 120, 136, 139, 140, 142 }, //MALE
	{ 4, 5, 6, 33, 34, 35, 36, 37, 61, 63, 135, 141 } //FEMALE
};

void unsafe_getNaked( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	getNaked( player );
}

//import void getNaked( Critter& cr ) from "map_start";
void getNaked( Critter& cr )
{
	if( cr.ParamBase[ ST_BODY_TYPE ] >= BT_SUPER_MUTANT ) //not man, woman, child
		return;

	bool isMale = ( cr.Stat[ ST_GENDER ] == GENDER_MALE );
	uint crType = cr.Stat[ ST_BASE_CRTYPE ];
	//if( naked_skins[isMale ? 0 : 1 ].find(crType) != -1 )
	if(true) //Отключил, чет заёбывают уже своими хуёвыми идеями.
	{
		cr.Say( SAY_EMOTE_ON_HEAD, "раздевается" );
		cr.Animate( 0, ANIM2_USE, null, false, true );
		cr.Animate( 0, ANIM2_PICKUP, null, false, true );
		
		Item@ armor = cr.GetItem( 0, SLOT_ARMOR );
		if( valid( armor ) )
		{
			_CritMoveItem( cr, armor, SLOT_INV );
		}
		else
		{
			cr.ParamBase[ ST_BASE_CRTYPE ] = isMale ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F;
			cr.ChangeCrType( isMale ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F );
		}
	}
}

void RadomSkin( Critter& cr )
{
	bool isMale = ( cr.Stat[ ST_GENDER ] == GENDER_MALE );
	uint crType = cr.Stat[ ST_BASE_CRTYPE ];
	crType = skins[isMale ? 0 : 1 ][Random( 0, skins[isMale ? 0 : 1 ].length() - 1 )];
	cr.ParamBase[ ST_BASE_CRTYPE ] = crType;
	cr.ChangeCrType( crType );
	
	/*
	cr.ShowScreen( SCREEN_DIALOGBOX, 2, "answer_StartKit" );
	cr.Say( SAY_DIALOGBOX_TEXT, "Что бы ваш персонаж не сверкал голой жопой, вам выдали случайный скин.\nЧто бы раздеться - используйте комманду:\n~naked" );
	cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "вернуть дикаря" );
	cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "можно другой?" );
	*/
}

void answer_StartKit( Critter& player, uint answerI, string& answerS )
{
	if( answerI == 0 )
	{
		player.ParamBase[ ST_BASE_CRTYPE ] = player.Stat[ ST_GENDER ] == GENDER_MALE ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F;
		player.ChangeCrType( player.Stat[ ST_GENDER ] == GENDER_MALE ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F );
		player.Say( SAY_NETMSG, "Не забывайте, что ваш персонаж сейчас практически голый. Это вызывает подозрения!" );
	}
	if( answerI == 1 )
	{
		if( player.Param[ ST_VAR5 ] > 10 )
			player.Say( SAY_NETMSG, "Больше нельзя. Надо было внимательней читать текст - стартовый Гид говорил, что смена скина доступна на обучающей карте." );
		else
		{
			player.ParamBase[ ST_VAR5 ]++;
			RadomSkin( player );
		}		
	}
}

import bool isGM( Critter& player ) from "gm";

void _crIn( Map& map, Critter& cr )
{
    if( cr.IsPlayer() && !isGM( cr ) )
    {
        cr.SetEvent( CRITTER_EVENT_USE_ITEM, "_Start_Player_use" );
        cr.SetEvent( CRITTER_EVENT_DROP_ITEM, "_Start_Player_drop" );
        cr.SetEvent( CRITTER_EVENT_ATTACK, "_Start_Player_attack" );
        cr.SetEvent( CRITTER_EVENT_DEAD, "_Start_Player_dead" );
    }
}

void _crOut( Map& map, Critter& cr )
{
	cr.SetEvent( CRITTER_EVENT_USE_ITEM, null );
	cr.SetEvent( CRITTER_EVENT_DROP_ITEM, null );
	cr.SetEvent( CRITTER_EVENT_ATTACK, null );
	cr.SetEvent( CRITTER_EVENT_DEAD, null );

	// if( cr.ParamBase[ QST_GAMEMODE ] == GAME_START )
	// {
		// Item@[] items;
		// cr.GetItems( SLOT_INV, items );
		// cr.GetItems( SLOT_HAND1, items );
		// cr.GetItems( SLOT_HAND2, items );
		// DeleteItems( items );	
	// }
}

void _Start_Player_dead( Critter& cr, Critter@ killer )
{
    Map@ start = GetMapByPid( MAP_UTILITY_START, 0 );
    _crOut( start, cr );
    Item@[] items;
    cr.GetItems( SLOT_ARMOR, items );
    cr.GetItems( SLOT_INV, items );
    cr.GetItems( SLOT_HAND1, items );
    cr.GetItems( SLOT_HAND2, items );
    DeleteItems( items );
}

void _Start_Player_drop( Critter& cr, Item& item )
{
    cr.Say( SAY_NETMSG, "Предмет был поглощен пустотой." );
    if( valid( item ) )
        DeleteItem( item );
}

bool _Start_Player_attack( Critter& cr, Critter& target )
{
    cr.Say( SAY_NETMSG, "Вам кажется сейчас это неуместо." );
    return true;
}

bool _Start_Player_use( Critter& cr, Item& item, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_NETMSG, "Вам кажется сейчас это неуместо." );
    return true;
}
