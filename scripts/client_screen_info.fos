// Info Screen for displaying any kind of text info

#include "_client_defines.fos"
#include "client_gui_h.fos"
#include "_utils.fos"
#include "serializator.fos"

string panelText = "";

class ScreenMain : IGUIScreenCallbackShow, IGUIScreenCallbackHide
{
    IGUIScreenOpt@ screenOpt;
	InfoScreenOk@ OkButton;
    TextPanel @ Text;
	
    void OnShow( int p0, int p1, int p2 )
    {
        SetText( panelText );
    }

    void OnHide( int p0, int p1, int p2 )
    {}
    
	uint8 GetTextLegth()
    {
        return Text.GetText().length();
    }
	
    void SetText( string text )
    {
        Text.SetText( text );
    }
	
	string GetText()
    {
        return Text.GetText();
    }

}

class TextPanel : IGUIElementCallbackInit, IGUIElementCallbackDraw
{
    IGUIElementOpt @ elementOpt;
    ScreenMain@ Instance;

    TextPanel( ScreenMain & instance )
    {
        @Instance = instance;
        @Instance.Text = this;

    }

    void OnInit()
    {
        @elementOpt = GUI_GetElementOptions();
    }

    void OnDraw( int posX, int posY, int w, int h )
	{
		SetText( panelText );
	}

    void SetText( string text )
    {
		elementOpt.Text( "" + text, FONT_FALLOUT, COLOR_GREEN, 0, FT_BORDERED );
    }

    string GetText()
    {
        return elementOpt.GetText();
    }
	
	uint8 GetTextLegth()
    {
        return elementOpt.GetText().length();
    }
}

class TestScreenButtonShow : IGUIElementCallbackMouseClick
{
    void OnMouseClick( int click )
    {
        ::ShowScreen( CLIENT_SCREEN_INFOSCREEN, 30, 3, 3 );
    }
}

class InfoScreenOk : IGUIElementCallbackInit, IGUIElementCallbackMouseClick
{
    IGUIElementOpt@ Options;
    ScreenMain@ Instance;

    InfoScreenOk( ScreenMain & instance )
    {
        @Instance = instance;
    }

    void OnInit()
    {
        @Options = GUI_GetElementOptions();
        @Instance.OkButton = this;
    }

    void OnMouseClick( int click )
    {
        ::HideScreen( 0, 0, 0, 0 );
		ChangeCursor( GetLastCursor() );
    }
}

void ShowScreen( int p0, int p1, int p2, string@ p3, int[]@ p4 )
{
	screenType = p0;
	string@[] tempStrs = split( p3, "#" );
	string FormattedStr;
	if( tempStrs.length() >= 2 )
	{
		FormattedStr = FormatTags( tempStrs[0], tempStrs[1] );
	}
	else
	{
		FormattedStr = tempStrs[0];
	}
	
    panelText = FormattedStr;
    ShowScreen( CLIENT_SCREEN_INFOSCREEN, 0, p1, p2 );
}

void HideScreen( int p0, int p1, int p2, string@ p3, int[]@ p4 )
{
    GUI_HideScreen( CLIENT_SCREEN_INFOSCREEN, 0, 0, 0 );
}

void InitInfoScreen()
{
    ScreenMain screenMain();
    GUI_CreateScreen( CLIENT_SCREEN_INFOSCREEN, "info_screen.png" )
    .CallbackHide( screenMain )
    .CallbackShow( screenMain )
    .AutoCursor( true, CURSOR_DEFAULT );

    TextPanel InputDigitsB( screenMain );
    GUI_AddScreenElement( CLIENT_SCREEN_INFOSCREEN, "", 25, 39 )
    .CallbackInit( InputDigitsB )
	.Position( 25, 39, 355, 391 )
	.Text( "", FONT_FALLOUT, COLOR_LGREEN, 0, FT_CENTERX | FT_BORDERED );
	
	InfoScreenOk OkButton( screenMain );
    GUI_AddScreenElement( CLIENT_SCREEN_INFOSCREEN, "MENUUP.FRM", 321, 466 )
    .CallbackInit( OkButton )
    .CallbackMouseClick( OkButton )
    .DownPic( "MENUDOWN.FRM" );
}

void ShowDrugScreen( int size, int p1, int p2, string@ p3, int[]@ net_pack )
{
	Serializator data(net_pack);
	int16[] drugs;
	data.Get( drugs );
	
	string text = "";
	string lexems = "";

	text += STR_INSERT_TEXT_LINE( STR_ACTIVE_DRUGS_DESCRIPTION );
	string info = "$list " + YELLOW;
	for( uint i = 0; i < drugs.length(); i++ )
	{
		info += "\n" + STR_INSERT_PARAM_NAME(drugs[i]);
	}
	lexems += info;
	text += "\n";
	text += STR_INSERT_TEXT_LINE( STR_ACTIVE_DRUGS_LABEL );
	text += "\n";

	for( int i = 0; i < size; i++)
	{		
		uint8 phase = 0;
		uint16 pid = 0;
		uint32 time = 0;
		data.Get( phase ).Get( pid ).Get( time );
		string item_name;
		if( IN_RANGE( pid, ITEM_SUBTYPE_DRUG_BEGIN, ITEM_SUBTYPE_DRUG_END ) )
		{
			uint j = pid - ITEM_SUBTYPE_DRUG_BEGIN;
			item_name = STR_INSERT_TEXT_LINE( STR_DRUG_TYPE_DOPE + j );
		}
		else
		{
			item_name = STR_INSERT_ITEM_LINE( pid * 100 );
		}
		
		string name = " [" + phase + "]" + " '" + item_name + "' ";
		string timeStr = DeltaTime_HMS_short( time );
		string lex = "$description" + i + name + timeStr;
		text += "@lex description" + i + "@";
		lexems += lex;
		text += "\n";
	}
	
	panelText = FormatTags( text, lexems );
    ShowScreen( CLIENT_SCREEN_INFOSCREEN, 0, p1, p2 );
}